# Flyway integrated in Spring Boot Project
> The objective of this demo is to do migrations through the usage of the framework **Flyway**, which allows to place schema 
migration scripts in the same repository as the code, achieving direct versioning of the scripts alongside the versioning 
of the application.

# Table of Contents
  * [General Overview](#general-overview)
  * [Getting Started](#getting-started)
    * [Development Environment Setup](#development-environment-setup)
    * [Installation](#installation)
    * [Run](#run)
  * [Run with MySQL database](#run-with-mysql-database)
    * [Run Database](#run-database)
    * [Installation](#installation-mysql)
    * [Run](#run-mysql)
  * [How does Flyway work](#how-does-flyway-work)
    * [Update Flyway changes through maven plugin](#update-flyway-changes-through-maven-plugin)
    * [Other possible Flyway properties](#other-possible-flyway-properties)

## General Overview
- Follows a **DDD (Domain Driven Design)** architecture;
- Programmed in **Java** with the support of **Spring**;
- It's integrated with an embedded database (**H2**) and with a **MySQL** database;
- Uses **Flyway** for automated database migrations and versioning.

## Getting Started
### Development Environment Setup
### Installation
```bash
$ mvn clean install
```
### Run
```bash
$ mvn spring-boot:run
```
Default page: http://localhost:8080/api/roles

## Run with MySQL database
### Run Database
```bash
$ docker-compose up -d
```
### Installation (MySQL)
```bash
$ mvn clean install
```
### Run (MySQL)
```bash
$ mvn spring-boot:run -"Dspring-boot.run.profiles"=mysql -Pmysql
```

## How does Flyway work
Spring will inject automatically into Flyway it's database configuration from the datasource property inside _application.yml_.
With that, when starting the Spring application, Flyway will go, by default, to the package _*resources/db/migration_ and runs all the sql scripts (_*.sql_ files) inside it.
If you want to change the package that Flyway loads the files it must be used in the following property inside _application.yml_:
```
spring.flyway.locations: classpath:db/migration/example1,classpath:db/migration/example2
```
The sql files must have the following convention: _V1__Example.sql_
- _V1_: This will specify the version (in this case 1) to Flyway;
  - If there is a small version change to 1.1 it should be _V1_1_
- _Example_: Description of what the script will do;
- __: Separator between version and description.

**Note:** Flyway saves the history of migrations inside a table automatically generated by it, the default name is
_flyway_schema_history_ and contains important information about each migration file, like version, description, script, checksum, date.

### Update Flyway changes through maven plugin
- Validate the migration:
  ```bash
  $ mvn flyway:validate 
  ``` 
- If there is a conflict with another version:
  - Expected:
    - Cleans all history of Flyway table (avoid at all costs in production):
      ```bash
      $ mvn flyway:clean 
      ``` 
      **OR**
    - Delete the conflicting record from the database, for instance for the script **_V1_**__Exmple.sql (version 1):
      ```
      DELETE FROM flyway_schema_history WHERE version = 1;
      ``` 
  - Unexpected:
    - Ignore the changes and migration isn't done:
      ```bash
      $ mvn flyway:repair 
      ``` 
      **OR**
    - Manually reverting the changed sql file, for example through git.
- If everything is good for the migration, then run the command:
  ```bash
  $ mvn flyway:migrate
  ``` 
- To check the migration history:
  ```bash
  $ mvn flyway:info 
  ```
**Note:** To be able to use Flyway maven plugin (_mvn flyway_) it is required the access to some configurations (database related)
which unfortunately can't be automatized through Spring at the moment.
To abstract those mandatory configurations from the _pom.xml_ it can be used a Flyway configuration file (flyway.conf)
and the maven Flyway command should be run in the same location as of the configuration file (root of project in this case).

### Other possible Flyway properties
```
spring.flyway.sql-migration-prefix: V
spring.flyway.repeatable-sql-migration-prefix: R
spring.flyway.sql-migration-separator: __
spring.flyway.sql-migration-suffixes: .sql
spring.flyway.schemas: schema1, schema2
```
Disable Flyway execution on the run of the Spring App:
```
spring.flyway.enabled: false
```
